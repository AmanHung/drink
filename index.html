<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>藥劑科盤點日 - 飲料點單系統</title>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6; /* Gray-100 */
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #10b981;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    // ==========================================
    //  請將您的 Google Apps Script 網址貼在下方引號內
    // ==========================================
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbz2ALgot8-TvsN4WglUQwDAPc9UInHkOovjXi5pBF7docl5X4CLa-jSnLk-W5vlFUJ8_w/exec"; 


    // --- Icons ---
    const Icons = {
        Coffee: ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" y1="2" x2="6" y2="4"/><line x1="10" y1="2" x2="10" y2="4"/><line x1="14" y1="2" x2="14" y2="4"/></svg>
        ),
        Copy: ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
        ),
        X: ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        ),
        CheckCircle: ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>
        ),
        Refresh: ({ size = 24, className = "" }) => (
             <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>
        ),
        Calendar: ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        )
    };

    const ICE_OPTIONS = ["正常", "少冰", "微冰", "去冰", "溫", "熱"];
    const SUGAR_OPTIONS = ["正常", "少糖(7分)", "半糖(5分)", "微糖(3分)", "一分糖", "無糖"];

    // --- Helpers ---
    const getYearMonth = (timestamp) => {
        const date = new Date(timestamp);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        return `${year}-${month}`;
    };

    const getCurrentYearMonth = () => {
        const now = new Date();
        return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    };

    // --- Components ---

    const Modal = ({ isOpen, onClose, children }) => {
        if (!isOpen) return null;
        return (
            <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black bg-opacity-50 transition-opacity">
                <div className="bg-white w-full sm:w-96 rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl transform transition-transform duration-300">
                    {children}
                </div>
            </div>
        );
    };

    const Notification = ({ message, type, onClose }) => {
        if (!message) return null;
        const bgColor = type === 'error' ? 'bg-red-500' : 'bg-emerald-600';
        return (
             <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 ${bgColor} text-white px-6 py-3 rounded-full shadow-lg z-50 flex items-center gap-2 transition-all duration-300`}>
                <span>{message}</span>
            </div>
        );
    };

    const App = () => {
        const [staffList, setStaffList] = React.useState([]);
        const [menuData, setMenuData] = React.useState({ storeName: "載入中...", categories: [] });
        const [allOrders, setAllOrders] = React.useState([]); 
        const [loading, setLoading] = React.useState(true);
        const [submitting, setSubmitting] = React.useState(false);
        const [notification, setNotification] = React.useState({ message: "", type: "success" });

        const [currentUser, setCurrentUser] = React.useState("");
        const [isModalOpen, setIsModalOpen] = React.useState(false);
        const [selectedMonth, setSelectedMonth] = React.useState(getCurrentYearMonth());
        
        const [selectedItem, setSelectedItem] = React.useState(null);
        const [formSize, setFormSize] = React.useState("L");
        const [formIce, setFormIce] = React.useState("微冰");
        const [formSugar, setFormSugar] = React.useState("微糖(3分)");
        const [formNote, setFormNote] = React.useState("");
        const [currentPrice, setCurrentPrice] = React.useState(0);

        const fetchData = async () => {
            if (GAS_API_URL.includes("貼在這裡")) {
                setLoading(false);
                return;
            }
            setLoading(true);
            try {
                const res = await fetch(GAS_API_URL);
                const data = await res.json();
                setStaffList(["請選擇人員...", ...data.staff]);
                setMenuData(data.menu);
                setAllOrders(data.orders);
            } catch (error) {
                console.error("Fetch Error:", error);
                showNotification("資料讀取失敗，請檢查網路或網址", "error");
            } finally {
                setLoading(false);
            }
        };

        React.useEffect(() => {
            fetchData();
        }, []);

        const availableMonths = React.useMemo(() => {
            const months = new Set();
            months.add(getCurrentYearMonth());
            allOrders.forEach(order => {
                months.add(getYearMonth(order.id));
            });
            return Array.from(months).sort().reverse();
        }, [allOrders]);

        const filteredOrders = React.useMemo(() => {
            return allOrders.filter(order => getYearMonth(order.id) === selectedMonth);
        }, [allOrders, selectedMonth]);

        const totalAmount = filteredOrders.reduce((sum, order) => sum + order.price, 0);

        React.useEffect(() => {
            if (selectedItem) {
                setCurrentPrice(formSize === "L" ? selectedItem.priceL : selectedItem.priceM);
            }
        }, [selectedItem, formSize]);

        const showNotification = (msg, type = 'success') => {
            setNotification({ message: msg, type });
            setTimeout(() => setNotification({ message: "", type: "success" }), 3000);
        };

        const handleOpenItem = (item) => {
            const currentYM = getCurrentYearMonth();
            if (selectedMonth !== currentYM) {
                setSelectedMonth(currentYM);
                showNotification("已切換至當月進行點餐");
            }
            
            setSelectedItem(item);
            
            // 自動判斷預設尺寸：如果有 L 則預設 L，否則預設 M
            // 判斷依據：價格不是空字串
            const hasL = item.priceL !== "" && item.priceL !== null && item.priceL !== undefined;
            setFormSize(hasL ? "L" : "M");
            
            setFormIce("微冰");
            setFormSugar("微糖(3分)");
            setFormNote("");
            setIsModalOpen(true);
        };

        const handleCopyOrder = (order) => {
            const currentYM = getCurrentYearMonth();
            if (selectedMonth !== currentYM) {
                setSelectedMonth(currentYM);
            }

            let foundItem = null;
            menuData.categories.forEach(cat => {
                const item = cat.items.find(i => i.name === order.drink);
                if (item) foundItem = item;
            });

            if (foundItem) {
                setSelectedItem(foundItem);
                setFormSize(order.size);
                setFormIce(order.ice);
                setFormSugar(order.sugar);
                setFormNote(order.note);
                setIsModalOpen(true);
                showNotification("已複製內容，請確認姓名後送出");
            } else {
                showNotification("此商品已不在目前菜單中", "error");
            }
        };

        const handleSubmit = async () => {
            if (!currentUser || currentUser === "請選擇人員...") {
                showNotification("請先選擇訂購人員姓名！", "error");
                return;
            }
            if (GAS_API_URL.includes("貼在這裡")) {
                showNotification("請先設定 Google Apps Script 網址", "error");
                return;
            }
            setSubmitting(true);

            const newOrder = {
                name: currentUser,
                drink: selectedItem.name,
                size: formSize,
                ice: formIce,
                sugar: formSugar,
                price: currentPrice,
                note: formNote
            };

            try {
                await fetch(GAS_API_URL, {
                    method: "POST",
                    body: JSON.stringify(newOrder),
                    mode: "no-cors"
                });

                showNotification("訂購成功！");
                setIsModalOpen(false);
                
                const optimisticOrder = { 
                    ...newOrder, 
                    id: Date.now(),
                    timestamp: new Date().toISOString()
                };
                setAllOrders([optimisticOrder, ...allOrders]);
                setTimeout(fetchData, 1500);

            } catch (error) {
                console.error("Submit Error:", error);
                showNotification("送出失敗，請重試", "error");
            } finally {
                setSubmitting(false);
            }
        };

        if (GAS_API_URL.includes("貼在這裡")) {
             return (
                 <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center">
                    <h1 className="text-2xl font-bold mb-4">系統尚未設定</h1>
                    <p className="mb-4">請依照教學文件，將 Google Apps Script 網址填入 HTML 檔案的第 48 行。</p>
                    <div className="bg-gray-200 p-4 rounded text-sm font-mono break-all">
                        const GAS_API_URL = "你的_GOOGLE_APPS_SCRIPT_網址_貼在這裡";
                    </div>
                 </div>
             )
        }

        if (loading && allOrders.length === 0 && staffList.length === 0) {
            return (
                <div className="min-h-screen flex flex-col items-center justify-center">
                    <div className="spinner mb-4"></div>
                    <p className="text-gray-500">正在讀取今日菜單與歷史紀錄...</p>
                </div>
            );
        }

        return (
            <div className="min-h-screen pb-20">
                <Notification message={notification.message} type={notification.type} />

                {/* Header */}
                <header className="bg-emerald-600 text-white p-4 sticky top-0 z-40 shadow-md">
                    <div className="flex justify-between items-center max-w-2xl mx-auto">
                        <div>
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                <Icons.Coffee size={24} /> 盤點日快樂
                            </h1>
                            <p className="text-emerald-100 text-sm">今日店家：{menuData.storeName}</p>
                        </div>
                        <div className="text-right">
                             <div className="text-xs text-emerald-200">
                                {selectedMonth === getCurrentYearMonth() ? '本月總計' : `${selectedMonth} 總計`}
                             </div>
                             <div className="font-bold text-xl">${totalAmount}</div>
                        </div>
                    </div>
                </header>

                <main className="max-w-2xl mx-auto p-4 space-y-6">
                    
                    {/* User Selection */}
                    <section className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <label className="block text-gray-700 font-bold mb-2">我是...</label>
                        <select 
                            value={currentUser}
                            onChange={(e) => setCurrentUser(e.target.value)}
                            className="w-full p-3 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-lg"
                        >
                            {staffList.map((name, idx) => (
                                <option key={idx} value={name}>{name}</option>
                            ))}
                        </select>
                    </section>

                    {/* Menu Section */}
                    <section>
                        <h2 className="text-lg font-bold text-gray-800 mb-3">選飲料</h2>
                        <div className="space-y-4">
                            {menuData.categories.map((cat, idx) => (
                                <div key={idx}>
                                    <h3 className="text-emerald-600 font-medium mb-2 pl-1 border-l-4 border-emerald-500">{cat.name}</h3>
                                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                        {cat.items.map(item => (
                                            <button 
                                                key={item.id}
                                                onClick={() => handleOpenItem(item)}
                                                className="bg-white p-3 rounded-lg shadow-sm border border-gray-100 hover:border-emerald-500 hover:shadow-md transition-all text-left active:scale-95 flex flex-col justify-between"
                                            >
                                                <div className="w-full">
                                                    <div className="font-bold text-gray-800">{item.name}</div>
                                                    {/* 【新增】備註顯示區塊 */}
                                                    {item.description && (
                                                        <div className="text-[12px] text-amber-600 font-normal mt-1 leading-tight">{item.description}</div>
                                                    )}
                                                </div>
                                                <div className="text-gray-500 text-sm mt-2 font-medium">
                                                    ${item.priceL} (L)
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </section>

                    {/* Order List Section */}
                    <section>
                        <div className="flex items-center justify-between mb-3">
                            <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                                點餐紀錄
                                <button onClick={fetchData} className="text-gray-400 hover:text-emerald-600 transition-colors">
                                    <Icons.Refresh size={18} />
                                </button>
                            </h2>
                            
                            <div className="flex items-center gap-2 bg-white border border-gray-300 rounded-lg px-2 py-1">
                                <Icons.Calendar size={16} className="text-gray-500" />
                                <select 
                                    value={selectedMonth}
                                    onChange={(e) => setSelectedMonth(e.target.value)}
                                    className="bg-transparent text-sm font-medium text-gray-700 outline-none cursor-pointer"
                                >
                                    {availableMonths.map(month => (
                                        <option key={month} value={month}>{month}</option>
                                    ))}
                                </select>
                            </div>
                        </div>

                        <div className="space-y-3">
                            {filteredOrders.length === 0 ? (
                                <p className="text-center text-gray-400 py-8">
                                    {selectedMonth === getCurrentYearMonth() 
                                        ? "這個月還沒有人點餐，當第一個吧！" 
                                        : "該月份無訂單紀錄"}
                                </p>
                            ) : (
                                filteredOrders.map((order, index) => (
                                    <div key={index} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className="font-bold text-gray-900">{order.name}</span>
                                                <span className="text-xs bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded">{order.size}</span>
                                                <span className="text-xs text-gray-400">{order.dateStr}</span>
                                            </div>
                                            <div className="text-gray-700 font-medium">{order.drink}</div>
                                            <div className="text-sm text-gray-500">
                                                {order.sugar} / {order.ice}
                                                {order.note && <span className="text-orange-500 ml-2">註: {order.note}</span>}
                                            </div>
                                        </div>
                                        <div className="flex flex-col items-end gap-2">
                                            <span className="font-bold text-gray-800">${order.price}</span>
                                            <button 
                                                onClick={() => handleCopyOrder(order)}
                                                className="flex items-center gap-1 text-xs bg-blue-50 text-blue-600 px-2 py-1.5 rounded-lg hover:bg-blue-100 active:bg-blue-200 transition-colors"
                                            >
                                                <Icons.Copy size={14} /> +1 同款
                                            </button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </section>
                </main>

                <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)}>
                    {selectedItem && (
                        <div className="space-y-4">
                            <div className="flex justify-between items-start border-b pb-3 border-gray-100">
                                <div>
                                    <h3 className="text-xl font-bold text-gray-900">{selectedItem.name}</h3>
                                    {/* 【新增】Modal 裡面也顯示備註 */}
                                    {selectedItem.description && (
                                        <p className="text-sm text-amber-600 mt-1">{selectedItem.description}</p>
                                    )}
                                    <p className="text-emerald-600 font-medium mt-1">${currentPrice}</p>
                                </div>
                                <button onClick={() => setIsModalOpen(false)} className="p-1 rounded-full hover:bg-gray-100">
                                    <Icons.X size={24} className="text-gray-400" />
                                </button>
                            </div>

                            {/* Size Selection */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">容量 (Size)</label>
                                <div className="flex gap-2">
                                    {['M', 'L']
                                        .filter(size => {
                                            // 過濾掉沒有價格(沒有該尺寸)的選項
                                            if (size === 'M') return selectedItem.priceM !== "" && selectedItem.priceM !== null;
                                            if (size === 'L') return selectedItem.priceL !== "" && selectedItem.priceL !== null;
                                            return false;
                                        })
                                        .map(size => (
                                        <button
                                            key={size}
                                            onClick={() => setFormSize(size)}
                                            className={`flex-1 py-2 rounded-lg border text-sm font-medium transition-all ${
                                                formSize === size 
                                                ? 'bg-emerald-500 text-white border-emerald-500 shadow-md' 
                                                : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'
                                            }`}
                                        >
                                            {size} {size === 'L' ? `($${selectedItem.priceL})` : `($${selectedItem.priceM})`}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">冰塊溫度</label>
                                <div className="grid grid-cols-3 gap-2">
                                    {ICE_OPTIONS.map(ice => (
                                        <button
                                            key={ice}
                                            onClick={() => setFormIce(ice)}
                                            className={`py-2 rounded-lg border text-xs font-medium transition-all ${
                                                formIce === ice 
                                                ? 'bg-blue-500 text-white border-blue-500 shadow-md' 
                                                : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'
                                            }`}
                                        >
                                            {ice}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">甜度</label>
                                <div className="grid grid-cols-3 gap-2">
                                    {SUGAR_OPTIONS.map(sugar => (
                                        <button
                                            key={sugar}
                                            onClick={() => setFormSugar(sugar)}
                                            className={`py-2 rounded-lg border text-xs font-medium transition-all ${
                                                formSugar === sugar 
                                                ? 'bg-pink-500 text-white border-pink-500 shadow-md' 
                                                : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'
                                            }`}
                                        >
                                            {sugar}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">備註</label>
                                <input 
                                    type="text" 
                                    value={formNote}
                                    onChange={(e) => setFormNote(e.target.value)}
                                    placeholder="例如：珍珠多一點、不要分裝..."
                                    className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm"
                                />
                            </div>

                            <button 
                                onClick={handleSubmit}
                                disabled={submitting}
                                className={`w-full text-white py-3 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition-all ${
                                    submitting ? 'bg-gray-400 cursor-not-allowed' : 'bg-emerald-600 hover:bg-emerald-700 active:scale-95'
                                }`}
                            >
                                {submitting ? (
                                    <span>訂單送出中...</span>
                                ) : (
                                    <>
                                        <Icons.CheckCircle size={20} />
                                        確認加入 (${currentPrice})
                                    </>
                                )}
                            </button>
                        </div>
                    )}
                </Modal>

            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

</script>

</body>
</html>

